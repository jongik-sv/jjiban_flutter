{% extends "base.html" %}

{% block content %}
<!-- Header -->
<header class="bg-gray-800 border-b border-gray-700 px-4 py-3">
    <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">orchay - {{ project_name }}</h1>
        <span class="bg-blue-600 px-3 py-1 rounded text-sm">MODE: {{ mode }}</span>
    </div>
</header>

<!-- SSE ì—°ê²° (ê¹œë¹¡ì„ ì—†ëŠ” ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸) -->
<div id="sse-container"
     sse-connect="/api/events"
     sse-swap="tree-update"
     hx-swap="none">
    <!-- SSE ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ OOBë¡œ í•´ë‹¹ ìš”ì†Œë§Œ êµì²´ë¨ -->
</div>

<!-- Worker Bar (ì´ˆê¸° ë¡œë“œ í›„ SSEë¡œ ì—…ë°ì´íŠ¸) -->
<div id="workers-bar"
     class="bg-gray-800 border-b border-gray-700 px-4 py-2"
     hx-get="/api/workers"
     hx-trigger="load"
     hx-swap="innerHTML">
    <div class="animate-pulse flex items-center gap-4">
        <span class="text-gray-500">Workers: ë¡œë”© ì¤‘...</span>
    </div>
</div>

<!-- Main Content: 2-Column Layout -->
<main class="flex h-[calc(100vh-100px)]">
    <!-- Left: WBS Tree (ì´ˆê¸° ë¡œë“œ í›„ SSEë¡œ ìƒíƒœ ë°°ì§€ë§Œ ì—…ë°ì´íŠ¸) -->
    <div class="w-1/2 border-r border-gray-700 overflow-auto p-4"
         id="tree-panel"
         data-testid="tree-panel"
         hx-get="/api/tree"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="animate-pulse">
            <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
            <div class="h-4 bg-gray-700 rounded w-1/2 mb-2 ml-4"></div>
            <div class="h-4 bg-gray-700 rounded w-2/3 mb-2 ml-4"></div>
        </div>
    </div>

    <!-- Right: Task Detail (TSK-03-03: ì„ íƒ ì‹œ ìë™ ê°±ì‹  ì¶”ê°€) -->
    <div class="w-1/2 overflow-auto p-4" id="detail-panel" data-testid="detail-panel"
         data-selected-task="">
        <div class="flex items-center justify-center h-full text-gray-500">
            <p>Taskë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        </div>
    </div>
</main>

<!-- ì—ëŸ¬ í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- TSK-05-01: Document Viewer ëª¨ë‹¬ -->
<div id="document-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <!-- ë°°ê²½ ì˜¤ë²„ë ˆì´ (í´ë¦­ ì‹œ ë‹«ê¸°) -->
    <div id="document-modal-backdrop"
         class="absolute inset-0 bg-black bg-opacity-70"
         onclick="closeDocument()"></div>

    <!-- ëª¨ë‹¬ ì»¨í…ì¸  -->
    <div class="relative bg-gray-800 rounded-lg shadow-2xl w-[90%] max-w-[900px] max-h-[85vh] flex flex-col border border-gray-600">
        <!-- ëª¨ë‹¬ í—¤ë” -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-600">
            <div class="flex items-center gap-2">
                <span id="document-icon">ğŸ“„</span>
                <h3 id="document-title" class="font-medium text-gray-200">ë¬¸ì„œ ë¡œë”© ì¤‘...</h3>
            </div>
            <button id="document-close-btn"
                    onclick="closeDocument()"
                    class="text-gray-400 hover:text-white text-2xl leading-none px-2"
                    aria-label="ë‹«ê¸°">&times;</button>
        </div>

        <!-- ëª¨ë‹¬ ë³¸ë¬¸ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
        <div id="document-content"
             class="flex-1 overflow-auto p-6 prose prose-invert prose-sm max-w-none">
            <div class="flex items-center justify-center h-32">
                <span class="text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
    </div>
</div>

<!-- ê¸€ë¡œë²Œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
// ========== BR-02: ì„ íƒ ìƒíƒœ ê´€ë¦¬ (localStorage) ==========
const STATE_KEY = 'orchay_ui_state';

function saveState() {
    const state = {
        selectedTaskId: document.querySelector('.tree-node.task.selected')?.dataset.id || null,
        expandedWps: Array.from(document.querySelectorAll('.tree-node.wp[data-expanded="true"]'))
            .map(el => el.dataset.id)
    };
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
}

function restoreState() {
    try {
        const state = JSON.parse(localStorage.getItem(STATE_KEY) || '{}');

        // ì„ íƒëœ Task ë³µì›
        if (state.selectedTaskId) {
            const taskEl = document.querySelector(`.tree-node.task[data-id="${state.selectedTaskId}"]`);
            if (taskEl) {
                taskEl.classList.add('selected', 'bg-gray-700', 'ring-2', 'ring-blue-500');
            }
        }

        // í¼ì³ì§„ WP ë³µì›
        (state.expandedWps || []).forEach(wpId => {
            const wpNode = document.querySelector(`.tree-node.wp[data-id="${wpId}"]`);
            if (wpNode && wpNode.dataset.expanded === 'false') {
                // WP í¼ì¹˜ê¸° íŠ¸ë¦¬ê±°
                wpNode.click();
            }
        });
    } catch (e) {
        console.warn('ìƒíƒœ ë³µì› ì‹¤íŒ¨:', e);
    }
}

// ========== Task ì„ íƒ í‘œì‹œ ==========
function selectTask(el) {
    // ê¸°ì¡´ ì„ íƒ í•´ì œ
    document.querySelectorAll('.tree-node.task.selected').forEach(node => {
        node.classList.remove('selected', 'bg-gray-700', 'ring-2', 'ring-blue-500');
    });
    // ìƒˆë¡œìš´ ì„ íƒ
    el.classList.add('selected', 'bg-gray-700', 'ring-2', 'ring-blue-500');

    // TSK-03-03: Task Detail ìë™ ê°±ì‹  ì„¤ì •
    const taskId = el.dataset.id;
    const detailPanel = document.getElementById('detail-panel');
    detailPanel.setAttribute('data-selected-task', taskId);

    // ìƒíƒœ ì €ì¥
    saveState();
}

// ========== TSK-03-03: Task Detail ìë™ ê°±ì‹  ==========
let detailRefreshInterval = null;

function startDetailRefresh() {
    // ê¸°ì¡´ ì¸í„°ë²Œ ì œê±°
    if (detailRefreshInterval) {
        clearInterval(detailRefreshInterval);
    }

    // 5ì´ˆë§ˆë‹¤ ì„ íƒëœ Task ìƒì„¸ ê°±ì‹ 
    detailRefreshInterval = setInterval(() => {
        const detailPanel = document.getElementById('detail-panel');
        const selectedTaskId = detailPanel.getAttribute('data-selected-task');

        if (selectedTaskId) {
            htmx.ajax('GET', '/api/detail/' + selectedTaskId, {
                target: '#detail-panel',
                swap: 'morph:innerHTML'
            }).then(() => {
                // ê°±ì‹  í›„ì—ë„ data-selected-task ìœ ì§€
                detailPanel.setAttribute('data-selected-task', selectedTaskId);
            });
        }
    }, 5000);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ê°±ì‹  ì‹œì‘
document.addEventListener('DOMContentLoaded', startDetailRefresh);

// ========== WP í™•ì¥/ì¶•ì†Œ í† ê¸€ ==========
function toggleWp(el) {
    const wpId = el.dataset.id;
    const childrenDiv = document.getElementById('wp-children-' + wpId);
    const toggleIcon = el.querySelector('.toggle-icon');
    const isExpanded = el.dataset.expanded === 'true';

    if (!childrenDiv) {
        console.warn('Children container not found for WP:', wpId);
        return;
    }

    if (isExpanded) {
        // ì¶•ì†Œ
        childrenDiv.classList.remove('max-h-[2000px]', 'opacity-100');
        childrenDiv.classList.add('max-h-0', 'opacity-0');
        toggleIcon?.classList.remove('rotate-90');
        el.dataset.expanded = 'false';
    } else {
        // í™•ì¥
        childrenDiv.classList.remove('max-h-0', 'opacity-0');
        childrenDiv.classList.add('max-h-[2000px]', 'opacity-100');
        toggleIcon?.classList.add('rotate-90');
        el.dataset.expanded = 'true';
    }
    // ìƒíƒœ ì €ì¥
    saveState();
}

// ========== TSK-06-01: WP ì„ íƒ í‘œì‹œ ==========
function selectWp(el) {
    // ê¸°ì¡´ Task/WP ì„ íƒ í•´ì œ
    document.querySelectorAll('.tree-node.selected').forEach(node => {
        node.classList.remove('selected', 'bg-gray-700', 'ring-2', 'ring-blue-500');
    });
    // WP ì„ íƒ í‘œì‹œ
    el.classList.add('selected', 'bg-gray-700', 'ring-2', 'ring-blue-500');
}

// ========== TSK-06-01: ê²€ìƒ‰ í•„í„°ë§ ==========
function filterTree(query) {
    const q = query.toLowerCase().trim();
    const taskNodes = document.querySelectorAll('.tree-node.task');
    const wpContainers = document.querySelectorAll('.tree-root > .mb-3');

    if (!q) {
        // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì „ì²´ í‘œì‹œ
        taskNodes.forEach(n => n.style.display = '');
        wpContainers.forEach(n => n.style.display = '');
        return;
    }

    let matchCount = 0;

    // ë¨¼ì € ëª¨ë“  WP ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
    wpContainers.forEach(container => {
        container.style.display = 'none';
    });

    // Task ë…¸ë“œ í•„í„°ë§
    taskNodes.forEach(node => {
        const text = node.textContent.toLowerCase();
        const match = text.includes(q);
        node.style.display = match ? '' : 'none';

        if (match) {
            matchCount++;
            // ìƒìœ„ WP ì»¨í…Œì´ë„ˆ í‘œì‹œ ë° í¼ì¹˜ê¸°
            const wpContainer = node.closest('.mb-3[data-id]');
            if (wpContainer) {
                wpContainer.style.display = '';
                const wpNode = wpContainer.querySelector('.tree-node.wp');
                if (wpNode && wpNode.dataset.expanded === 'false') {
                    toggleWp(wpNode);
                }
            }
        }
    });
}

// ========== TSK-06-01: ì „ì²´ í¼ì¹˜ê¸°/ì ‘ê¸° ==========
let allExpanded = false;

function toggleExpandAll() {
    const btn = document.getElementById('expand-all-btn');
    const wps = document.querySelectorAll('.tree-node.wp');

    allExpanded = !allExpanded;
    btn.textContent = allExpanded ? 'ì „ì²´ ì ‘ê¸°' : 'ì „ì²´ í¼ì¹˜ê¸°';

    wps.forEach(wp => {
        const isExpanded = wp.dataset.expanded === 'true';
        if (allExpanded && !isExpanded) {
            toggleWp(wp);
        } else if (!allExpanded && isExpanded) {
            toggleWp(wp);
        }
    });
}

// ========== TSK-05-01: Document Viewer ==========
let currentDocumentTaskId = null;

async function openDocument(taskId, docName) {
    const modal = document.getElementById('document-modal');
    const content = document.getElementById('document-content');
    const title = document.getElementById('document-title');
    const icon = document.getElementById('document-icon');

    // ì €ì¥ (ESC í•¸ë“¤ëŸ¬ìš©)
    currentDocumentTaskId = taskId;

    // ì œëª© ë° ì•„ì´ì½˜ ì„¤ì •
    title.textContent = docName;
    const isImage = /\.(png|jpg|jpeg|gif|webp)$/i.test(docName);
    icon.textContent = isImage ? 'ğŸ–¼ï¸' : 'ğŸ“„';

    // ë¡œë”© í‘œì‹œ
    content.innerHTML = '<div class="flex items-center justify-center h-32"><span class="text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></div>';

    // ëª¨ë‹¬ í‘œì‹œ
    modal.classList.remove('hidden');

    try {
        const res = await fetch(`/api/document/${taskId}/${docName}`);

        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || `HTTP ${res.status}`);
        }

        if (isImage) {
            // ì´ë¯¸ì§€: img íƒœê·¸ë¡œ í‘œì‹œ
            content.innerHTML = `<div class="flex items-center justify-center"><img src="/api/document/${taskId}/${docName}" class="max-w-full max-h-[70vh] rounded" alt="${docName}" /></div>`;
        } else {
            // ë§ˆí¬ë‹¤ìš´: ì„œë²„ì—ì„œ ë Œë”ë§ëœ HTML ì§ì ‘ ì‚½ì…
            const html = await res.text();
            content.innerHTML = `<div class="markdown-body">${html}</div>`;

            // Mermaid ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
            const mermaidBlocks = content.querySelectorAll('pre code.language-mermaid');
            if (mermaidBlocks.length > 0) {
                mermaidBlocks.forEach((block, idx) => {
                    const code = block.textContent;
                    const container = document.createElement('div');
                    container.className = 'mermaid';
                    container.textContent = code;
                    container.id = `mermaid-${Date.now()}-${idx}`;
                    block.parentElement.replaceWith(container);
                });
                // Mermaid ë Œë”ë§ ì‹¤í–‰
                await mermaid.run({ querySelector: '.mermaid' });
            }
        }
    } catch (error) {
        console.error('Document load error:', error);
        content.innerHTML = `
            <div class="flex flex-col items-center justify-center h-32 text-red-400">
                <span class="text-4xl mb-2">âš ï¸</span>
                <p>ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                <p class="text-sm text-gray-500 mt-1">${error.message}</p>
            </div>
        `;
    }
}

function closeDocument() {
    const modal = document.getElementById('document-modal');
    modal.classList.add('hidden');
    currentDocumentTaskId = null;
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && currentDocumentTaskId !== null) {
        closeDocument();
    }
});

// ========== ì—ëŸ¬ í† ìŠ¤íŠ¸ ==========
function showToast(message, type = 'error') {
    const toast = document.createElement('div');
    toast.className = `px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transform transition-all duration-300 ${
        type === 'error' ? 'bg-red-800 text-red-100' : 'bg-gray-800 text-gray-100'
    }`;
    toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="${type === 'error'
                      ? 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
                      : 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}"/>
        </svg>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 hover:text-white">Ã—</button>
    `;
    document.getElementById('toast-container').appendChild(toast);

    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => toast.remove(), 5000);
}

// ========== HTMX ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ==========
// íŠ¸ë¦¬ ì´ˆê¸° ë¡œë“œ í›„ ìƒíƒœ ë³µì›
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'tree-panel') {
        restoreState();
    }
});

// ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì²˜ë¦¬
document.body.addEventListener('htmx:responseError', function(evt) {
    const status = evt.detail.xhr?.status;
    if (status === 404) {
        showToast('ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    } else if (status >= 500) {
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
});

document.body.addEventListener('htmx:sendError', function(evt) {
    showToast('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨. ì¬ì‹œë„ ì¤‘...', 'error');
});

// ë¡œë”© ì¸ë””ì¼€ì´í„° (Task Detail ë“± ì‚¬ìš©ì ìš”ì²­ì—ë§Œ ì ìš©)
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    evt.detail.target?.classList.add('htmx-request');
});

document.body.addEventListener('htmx:afterRequest', function(evt) {
    evt.detail.target?.classList.remove('htmx-request');
});
</script>

<!-- HTMX ë¡œë”© ìŠ¤íƒ€ì¼ -->
<style>
.htmx-request {
    position: relative;
}
.htmx-request::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(17, 24, 39, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}
